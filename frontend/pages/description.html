<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Buy Pure Silk Paithani Saree – Product Details | Saikrupa Paithani</title>



     <meta 
      name="description" 
      content="View detailed information of the selected Paithani saree. 100% pure silk, handwoven craftsmanship, premium borders & authentic Maharashtra designs." 
    />

    <meta 
      name="keywords" 
      content="paithani product details, pure silk paithani features, handwoven paithani specifications, bridal paithani description" 
    />
    <meta property="og:title" content="Saikrupa Paithani – Pure Silk Paithani Sarees" />
    <meta property="og:description" content="Buy handwoven pure silk Paithani sarees directly from Saikrupa Paithani." />
    <meta property="og:image" content="saikrupa_logo.jpg" />
    <meta property="og:type" content="website" />

     <link rel="icon" type="image/png" href="images/logo3.png" />
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet" href="nav.css">

<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          primary: "#800000",
          primaryLight: "#b30000",
          gold: "#D4AF37",
          lightGold: "#F2E8C9",
          cream: "#F8F4E3",
          darkRed: "#680000",
          gray: "#777",
          lightGray: "#f5f5f5",
          white: "#ffffff",
          black: "#333333",
        },
      },
    },
  };
</script>
<style>
  body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f4e3; }
  .saree-image { transition: transform 0.3s ease; }
  .saree-image:hover { transform: scale(1.02); }
  .thumbnail { cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease; }
  .thumbnail.active { border-color: #D4AF37; }

  /* Loading Animation with Logo */
  .loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 3000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }

  .loading-content {
    background-color: white;
    border-radius: 15px;
    padding: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .logo-loader {
    width: 100px;
    height: 100px;
    position: relative;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .logo-loader .logo {
    width: 80px;
    height: 80px;
    background: linear-gradient(45deg, #800000, #D4AF37);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    animation: logoPulse 2s infinite ease-in-out;
  }

  .logo-loader .logo i {
    font-size: 40px;
    color: white;
  }

  .loading-text {
    color: #800000;
    font-family: "Playfair Display", serif;
    font-size: 20px;
    margin-top: 15px;
    text-align: center;
  }

  @keyframes logoPulse {
    0%, 100% { 
      transform: scale(1); 
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    50% { 
      transform: scale(1.1); 
      box-shadow: 0 8px 25px rgba(128, 0, 0, 0.3);
    }
  }

  /* Success/Error Messages */
  .message-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 3000;
    align-items: center;
    justify-content: center;
  }

  .message-content {
    background-color: white;
    border-radius: 15px;
    padding: 30px;
    width: 400px;
    max-width: 90%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    text-align: center;
    position: relative;
  }

  .message-icon {
    font-size: 50px;
    margin-bottom: 20px;
  }

  .success-icon {
    color: #228b22;
  }

  .error-icon {
    color: #800000;
  }

  .message-text {
    font-size: 18px;
    margin-bottom: 25px;
    color: #333333;
    font-family: "Playfair Display", serif;
  }

  .message-btn {
    padding: 12px 30px;
    border: none;
    border-radius: 10px;
    background: linear-gradient(to right, #800000, #680000);
    color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    font-size: 16px;
    width: 100%;
  }

  .message-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(128, 0, 0, 0.3);
  }

  .slider-container {
    position: relative;
    overflow: hidden;
    padding: 10px 0;
  }
  
  .slider-track {
    display: flex;
    transition: transform 0.5s ease;
    gap: 20px;
  }
  
  .slider-item {
    flex: 0 0 calc(33.333% - 14px);
    min-width: calc(33.333% - 14px);
  }
  
  @media (max-width: 1024px) {
    .slider-item {
      flex: 0 0 calc(50% - 10px);
      min-width: calc(50% - 10px);
    }
  }
  
  @media (max-width: 640px) {
    .slider-item {
      flex: 0 0 100%;
      min-width: 100%;
    }
  }
  
  .slider-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(128, 0, 0, 0.8);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: all 0.3s ease;
  }
  
  .slider-btn:hover {
    background: #800000;
    transform: translateY(-50%) scale(1.1);
  }
  
  .slider-btn.prev {
    left: 10px;
  }
  
  .slider-btn.next {
    right: 10px;
  }
  
  .slider-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .slider-btn:disabled:hover {
    transform: translateY(-50%);
    background: rgba(128, 0, 0, 0.8);
  }
  
  .slider-dots {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    gap: 8px;
  }
  
  .slider-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #ddd;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .slider-dot.active {
    background: #800000;
    transform: scale(1.2);
  }

  /* Review rating styles */
  .review-stats {
    background: linear-gradient(135deg, #f8f4e3 0%, #f2e8c9 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }

  /* Stock status styles */
  .stock-out { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); }
  .stock-low { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); }
  .stock-good { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
</style>
</head>
<body class="bg-cream">

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="logo-loader">
        <div class="logo">
          <i class="fas fa-vest"></i>
        </div>
      </div>
      <div class="loading-text" id="loadingText">Processing...</div>
    </div>
  </div>

  <!-- Message Overlay -->
  <div class="message-overlay" id="messageOverlay">
    <div class="message-content">
      <div class="message-icon" id="messageIcon">
        <i class="fas fa-check-circle success-icon"></i>
      </div>
      <div class="message-text" id="messageText">Operation completed successfully!</div>
      <button class="message-btn" id="messageBtn">OK</button>
    </div>
  </div>

  <nav class="flex justify-between items-center p-4 bg-white shadow sticky top-0 z-50">
    <a href="dashboard.html" class="font-bold text-darkRed flex items-center">
      <img src="images/logo3.png" alt="Paithani Logo" class="h-16 w-16 rounded-full mr-3">
      <img src="saikrupa_logo.jpg" alt="SaiKrupa Paithani" class="logo-text-image" />
    </a>
    <ul class="hidden md:flex space-x-4">
        <li><a href="dashboard.html">Home</a></li>
      <li><a href="product.html" class="hover:text-primary">Collections</a></li>
      
      <li><a href="#testimonials" class="hover:text-primary">Testimonials</a></li>
      <li><a href="contact.html" class="hover:text-primary">Contact</a></li>
    </ul>
    <div class="flex items-center space-x-4">
      <div class="nav-icon">
          <a style="color: #920101" href="history.html">
            <i class="fas fa-shipping-fast mr-2"></i>
          </a>
        </div>
      <a href="signup_login.html"><i class="fas fa-user text-primary cursor-pointer"></i></a>
      <div class="relative">
        <a href="cart.html">
          <i class="fas fa-shopping-cart text-primary cursor-pointer text-xl"></i>
          <span class="cart-count absolute -top-2 -right-2 bg-primary text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">0</span>
        </a>
      </div>
      <div class="hamburger md:hidden text-2xl cursor-pointer">&#9776;</div>
    </div>
  </nav>

  <div class="container mx-auto px-6 py-4 text-gray-700">
    <a href="dashboard.html" class="hover:text-primary">Home</a> / 
    <a href="product.html" class="hover:text-primary">Sarees</a> / 
    <span id="breadcrumb-product" class="text-primary">Traditional Paithani Saree</span>
  </div>

  <div class="container mx-auto px-6 py-8" id="productDetail"></div>

  <!-- Review Section with API Integration -->
  <div class="container mx-auto px-6 py-8">
    <div class="review-section bg-white rounded-lg p-6 shadow">
      <h2 class="text-2xl font-bold text-primary mb-6">Customer Reviews</h2>
      
      <!-- Review Form -->
      <div class="review-form bg-lightGold p-4 rounded mb-6">
        <form id="reviewForm">
          <input type="text" id="reviewerName" placeholder="Your Name" class="w-full p-2 mb-2 rounded border" required />
         
          <div class="flex space-x-1 mb-2">
            <span class="star-rating text-2xl cursor-pointer" data-rating="1">☆</span>
            <span class="star-rating text-2xl cursor-pointer" data-rating="2">☆</span>
            <span class="star-rating text-2xl cursor-pointer" data-rating="3">☆</span>
            <span class="star-rating text-2xl cursor-pointer" data-rating="4">☆</span>
            <span class="star-rating text-2xl cursor-pointer" data-rating="5">☆</span>
          </div>
          <input type="hidden" id="ratingValue" value="0" />
          <textarea id="reviewText" placeholder="Share your experience with this product..." rows="3" class="w-full p-2 mb-2 rounded border" required maxlength="1000"></textarea>
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-500" id="charCount">0/1000 characters</span>
            <button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-darkRed transition duration-300">
              Submit Review
            </button>
          </div>
        </form>
      </div>

      <!-- Reviews List -->
      <div id="reviewsList" class="space-y-4"></div>

      <!-- Loading State -->
      <div id="reviewsLoading" class="text-center py-8">
        <i class="fas fa-spinner fa-spin text-2xl text-primary mb-2"></i>
        <p class="text-gray-600">Loading reviews...</p>
      </div>
    </div>
  </div>

  <!-- Related Products Slider -->
  <div class="container mx-auto px-6 py-8">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-primary">You May Also Like</h2>
      <div class="flex space-x-2">
        <button id="prevBtn" class="slider-btn prev" disabled>
          <i class="fas fa-chevron-left"></i>
        </button>
        <button id="nextBtn" class="slider-btn next">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
    
    <div class="slider-container">
      <div class="slider-track" id="sliderTrack"></div>
    </div>
    
    <div class="slider-dots" id="sliderDots"></div>
  </div>

<script>
let quantity = 1;
let currentProduct = null;
let currentSlide = 0;
let totalSlides = 0;
let slidesPerView = 3;

// Loading and Message overlays
const loadingOverlay = document.getElementById("loadingOverlay");
const loadingText = document.getElementById("loadingText");
const messageOverlay = document.getElementById("messageOverlay");
const messageIcon = document.getElementById("messageIcon");
const messageText = document.getElementById("messageText");
const messageBtn = document.getElementById("messageBtn");

// Show loading overlay
function showLoading(text = "Processing...") {
  loadingText.textContent = text;
  loadingOverlay.style.display = "flex";
}

// Hide loading overlay
function hideLoading() {
  loadingOverlay.style.display = "none";
}

// Show message overlay
function showMessage(text, isSuccess = true) {
  messageText.textContent = text;
  
  if (isSuccess) {
    messageIcon.innerHTML = '<i class="fas fa-check-circle success-icon"></i>';
  } else {
    messageIcon.innerHTML = '<i class="fas fa-exclamation-circle error-icon"></i>';
  }
  
  messageOverlay.style.display = "flex";
}

// Hide message overlay
function hideMessage() {
  messageOverlay.style.display = "none";
}

// Message button click
messageBtn.addEventListener("click", () => {
  hideMessage();
});

// Update slides per view based on screen size
function updateSlidesPerView() {
  if (window.innerWidth < 640) {
    slidesPerView = 1;
  } else if (window.innerWidth < 1024) {
    slidesPerView = 2;
  } else {
    slidesPerView = 3;
  }
  updateSlider();
}

// Initialize slider
function initSlider(products) {
  const sliderTrack = document.getElementById('sliderTrack');
  const sliderDots = document.getElementById('sliderDots');
  
  if (!products.length) {
    sliderTrack.innerHTML = '<p class="text-center py-4 text-gray-700 col-span-full">No related products found.</p>';
    return;
  }
  
  // Calculate total slides
  totalSlides = Math.ceil(products.length / slidesPerView);
  
  // Clear previous content
  sliderTrack.innerHTML = '';
  sliderDots.innerHTML = '';
  
  // Create slider items
  products.forEach(product => {
    const imageSrc = product.images?.[0]
     ? `http://localhost:5000/${product.images[0].replace(/\\/g, "/")}`
   // ? `https://saikrupapaithanisarees.onrender.com/${product.images[0].replace(/\\/g, "/")}`
      : "https://via.placeholder.com/300x300?text=No+Image";
    
    const sliderItem = document.createElement('div');
    sliderItem.className = 'slider-item';
    sliderItem.innerHTML = `
      <div class="bg-white rounded-lg shadow p-4 h-full flex flex-col">
        <img src="${imageSrc}" class="w-full h-48 object-cover rounded mb-3">
        <h3 class="font-bold text-primary text-lg mb-2">${product.name}</h3>
        <p class="text-primary font-semibold mb-3">₹${product.price ? product.price.toLocaleString() : '0'}</p>
        <a href="description.html?id=${product._id}" class="mt-auto bg-primary text-white px-4 py-2 rounded text-center hover:bg-darkRed transition duration-300">
          View Details
        </a>
      </div>
    `;
    sliderTrack.appendChild(sliderItem);
  });
  
  // Create dots
  for (let i = 0; i < totalSlides; i++) {
    const dot = document.createElement('div');
    dot.className = `slider-dot ${i === 0 ? 'active' : ''}`;
    dot.dataset.index = i;
    dot.addEventListener('click', () => goToSlide(i));
    sliderDots.appendChild(dot);
  }
  
  // Update slider position
  updateSlider();
}

// Update slider position
function updateSlider() {
  const sliderTrack = document.getElementById('sliderTrack');
  const sliderWidth = sliderTrack.offsetWidth;
  const itemWidth = sliderWidth / slidesPerView;
  
  sliderTrack.style.transform = `translateX(-${currentSlide * itemWidth}px)`;
  
  // Update buttons state
  document.getElementById('prevBtn').disabled = currentSlide === 0;
  document.getElementById('nextBtn').disabled = currentSlide >= totalSlides - 1;
  
  // Update dots
  const dots = document.querySelectorAll('.slider-dot');
  dots.forEach((dot, index) => {
    dot.classList.toggle('active', index === currentSlide);
  });
}

// Go to specific slide
function goToSlide(slideIndex) {
  currentSlide = slideIndex;
  updateSlider();
}

// Next slide
function nextSlide() {
  if (currentSlide < totalSlides - 1) {
    currentSlide++;
    updateSlider();
  }
}

// Previous slide
function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
    updateSlider();
  }
}

// Get authentication token
function getAuthToken() {
  return localStorage.getItem('authToken');
}

// Check if user is logged in
function checkLoginStatus() {
  const authToken = getAuthToken();
  const userIcon = document.querySelector('.fa-user');
  
  if (authToken) {
    userIcon.classList.remove('fa-user');
    userIcon.classList.add('fa-user-check');
    userIcon.style.color = 'green';
  }
}

// Get product ID from URL
function getProductId() {
  return new URLSearchParams(window.location.search).get("id");
}

// Quantity functions with stock validation - UPDATED
function increaseQuantity() { 
  if (currentProduct && quantity < currentProduct.stock) {
    quantity++; 
    document.getElementById("quantity").textContent = quantity; 
  } else {
    showMessage(`Maximum available quantity is ${currentProduct.stock}`, false);
  }
}

function decreaseQuantity() { 
  if(quantity > 1){ 
    quantity--; 
    document.getElementById("quantity").textContent = quantity; 
  } else {
    showMessage("Quantity cannot be less than 1", false);
  }
}

// Update cart count from API
async function updateCartCount() {
  try {
    const authToken = getAuthToken();
    
    if (!authToken) {
      document.querySelector(".cart-count").textContent = "0";
      return;
    }

    const res = await fetch("http://localhost:5000/api/cart", {
 // const res = await fetch("https://saikrupapaithanisarees.onrender.com", {
      headers: {
        "Authorization": `Bearer ${authToken}`
      }
    });

    if (res.ok) {
      const result = await res.json();
      if (result.success && result.cart && result.cart.items) {
        const totalItems = result.cart.items.reduce((sum, item) => sum + item.quantity, 0);
        document.querySelector(".cart-count").textContent = totalItems;
      } else {
        document.querySelector(".cart-count").textContent = "0";
      }
    } else {
      document.querySelector(".cart-count").textContent = "0";
    }
  } catch (err) {
    console.error("Failed to fetch cart count:", err);
    document.querySelector(".cart-count").textContent = "0";
  }
}

// Star rating system
function initStarRating() {
  const stars = document.querySelectorAll(".star-rating");
  const ratingValue = document.getElementById("ratingValue");
  stars.forEach(star=>{
    star.addEventListener("click", function(){
      const rating = parseInt(this.dataset.rating);
      ratingValue.value = rating;
      stars.forEach((s,i)=>{ 
        s.textContent = (i < rating ? "★" : "☆"); 
        s.style.color = "#D4AF37"; 
      });
    });
  });
}

// Character counter for review text
function initCharCounter() {
  const reviewText = document.getElementById('reviewText');
  const charCount = document.getElementById('charCount');
  
  reviewText.addEventListener('input', function() {
    const length = this.value.length;
    charCount.textContent = `${length}/1000 characters`;
    
    if (length > 1000) {
      charCount.classList.add('text-red-500');
    } else {
      charCount.classList.remove('text-red-500');
    }
  });
}

// API Functions for Reviews
async function submitReview(reviewData) {
  try {
    console.log('Submitting review:', reviewData);
    const res = await fetch("http://localhost:5000/api/reviews", {
  //  const res = await fetch("https://saikrupapaithanisarees.onrender.com/api/reviews", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(reviewData)
    });

    const result = await res.json();
    console.log('Review submission response:', result);
    
    if (res.ok && result.success) {
      return result;
    } else {
      throw new Error(result.message || "Failed to submit review");
    }
  } catch (err) {
    console.error("Submit review error:", err);
    throw err;
  }
}

// Get product reviews
async function fetchProductReviews(productId) {
  try {
    console.log('Fetching reviews for product:', productId);
    const res = await fetch(`http://localhost:5000/api/reviews?productId=${productId}`);
   //const res = await fetch(`https://saikrupapaithanisarees.onrender.com/api/reviews?productId=${productId}`);
    
    if (res.ok) {
      const result = await res.json();
      console.log('Fetched reviews:', result);
      return result.reviews || [];
    } else {
      console.error('Failed to fetch reviews, status:', res.status);
      return [];
    }
  } catch (err) {
    console.error("Fetch reviews error:", err);
    return [];
  }
}

async function fetchReviewStats(productId) {
  try {
    const res = await fetch(`http://localhost:5000/api/reviews/product/${productId}/summary`);
 // const res = await fetch(`https://saikrupapaithanisarees.onrender.com/api/reviews/product/${productId}/summary`);
    
    if (res.ok) {
      const result = await res.json();
      return result.summary || {};
    } else {
      return {};
    }
  } catch (err) {
    console.error("Fetch review stats error:", err);
    return {};
  }
}

// Review system with API integration - UPDATED
function handleReviewForm() {
  const form = document.getElementById("reviewForm");
  
  if (!form) {
    console.error('Review form not found!');
    return;
  }
  
  form.addEventListener("submit", async function(e){
    e.preventDefault();
    console.log('Form submitted');
    
    const name = document.getElementById("reviewerName").value;
    const rating = parseInt(document.getElementById("ratingValue").value);
    const text = document.getElementById("reviewText").value;
    const productId = getProductId();
    
    console.log('Form data:', { name, rating, text, productId });
    
    if(rating === 0){ 
      showMessage("Please select a rating!", false); 
      return; 
    }

    if (text.length > 1000) {
      showMessage("Review text must be 1000 characters or less.", false);
      return;
    }

    try {
      showLoading("Submitting your review...");

      const reviewData = {
        productId: productId,
        reviewerName: name,
        rating: rating,
        reviewText: text,
        status: 'approved'
      };

      console.log('Sending review data:', reviewData);

      const result = await submitReview(reviewData);
      
      if (result.success) {
        hideLoading();
        showMessage("Review submitted successfully!");
        form.reset();
        document.querySelectorAll(".star-rating").forEach(s => s.textContent = "☆");
        document.getElementById("ratingValue").value = 0;
        document.getElementById("charCount").textContent = "0/1000 characters";
        
        await renderReviews(productId);
        await renderReviewStats(productId);
      }
    } catch (err) {
      console.error('Review submission failed:', err);
      hideLoading();
      showMessage("Failed to submit review: " + err.message, false);
    }
  });
}

// Render review statistics
async function renderReviewStats(productId) {
  const stats = await fetchReviewStats(productId);
  const statsContainer = document.getElementById('reviewStats');
  
  if (stats.totalReviews > 0) {
    document.getElementById('averageRating').textContent = stats.averageRating.toFixed(1);
    document.getElementById('totalReviews').textContent = `${stats.totalReviews} Review${stats.totalReviews !== 1 ? 's' : ''}`;
    
    const avgStars = document.getElementById('averageStars');
    const fullStars = Math.floor(stats.averageRating);
    const hasHalfStar = stats.averageRating % 1 >= 0.5;
    
    let starsHtml = '';
    for (let i = 0; i < 5; i++) {
      if (i < fullStars) {
        starsHtml += '★';
      } else if (i === fullStars && hasHalfStar) {
        starsHtml += '½';
      } else {
        starsHtml += '☆';
      }
    }
    avgStars.innerHTML = starsHtml;
    
    const distributionContainer = document.getElementById('ratingDistribution');
    if (stats.distribution) {
      let distributionHtml = '';
      for (let i = 5; i >= 1; i--) {
        const ratingData = stats.distribution.find(d => d._id === i) || { count: 0 };
        const percentage = stats.totalReviews > 0 ? (ratingData.count / stats.totalReviews) * 100 : 0;
        
        distributionHtml += `
          <div class="flex items-center">
            <span class="w-8 text-gold font-semibold">${i}★</span>
            <div class="flex-1 bg-gray-200 rounded-full h-2 mx-2">
              <div class="bg-gold h-2 rounded-full" style="width: ${percentage}%"></div>
            </div>
            <span class="w-12 text-sm text-gray-600">${ratingData.count}</span>
          </div>
        `;
      }
      distributionContainer.innerHTML = distributionHtml;
    }
  } 
}

// Render reviews
async function renderReviews(productId) {
  const reviews = await fetchProductReviews(productId);
  const container = document.getElementById("reviewsList");
  const loading = document.getElementById("reviewsLoading");
  
  if (loading) loading.classList.add('hidden');
  
  if(reviews.length === 0){ 
    container.innerHTML = `
      <div class="text-center">
        <p class="text-gray-500"></p>
      </div>
    `; 
    return; 
  }
  
  const sortedReviews = reviews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  container.innerHTML = sortedReviews.map(review => `
    <div class="bg-lightGold p-4 rounded-lg">
      <div class="flex justify-between items-start mb-2">
        <div>
          <span class="font-bold text-primary text-lg">${review.reviewerName}</span>
          <div class="text-gold text-sm mt-1">
            ${"★".repeat(review.rating) + "☆".repeat(5 - review.rating)}
            <span class="text-gray-600 ml-2">${review.rating}/5</span>
          </div>
        </div>
        <span class="text-gray-500 text-sm">${new Date(review.createdAt).toLocaleDateString('en-IN', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}</span>
      </div>
      <p class="text-gray-700 mt-2">${review.reviewText}</p>
      ${review.adminEdited ? `
        <div class="text-xs text-gray-500 mt-2">
        </div>
      ` : ''}
      ${review.adminResponse ? `
        <div class="mt-3 p-3 bg-white rounded border-l-4 border-primary">
          <div class=""></div>
          <p class="text-gray-700">${review.adminResponse.responseText}</p>
          <div class="text-xs text-gray-500 mt-1">
            - ${review.adminResponse.respondedBy} on ${new Date(review.adminResponse.respondedAt).toLocaleDateString()}
          </div>
        </div>
      ` : ''}
    </div>
  `).join("");
}

// Fetch product data
async function fetchProductData(productId){
  try{
    const res = await fetch(`http://localhost:5000/api/products/${productId}`);
  // const res = await fetch(`https://saikrupapaithanisarees.onrender.com/api/products/${productId}`);
    const result = await res.json();
    
    if (res.ok) {
      currentProduct = result;
      renderProduct(currentProduct);
    } else {
      throw new Error(result.message || "Failed to load product");
    }
  } catch(err){
    console.error(err);
    document.getElementById("productDetail").innerHTML = "<p class='text-center text-red-600'>Failed to load product!</p>";
  }
}

// Render product details with stock management
function renderProduct(product){
  if(!product || !product.name){ 
    document.getElementById("productDetail").innerHTML = "<p class='text-center text-red-600'>Product not found!</p>"; 
    return; 
  }
  
  // Store current product globally for quantity management
  currentProduct = product;
  
  document.getElementById("breadcrumb-product").textContent = product.name;
  const stars = "★".repeat(product.popularity || 0) + "☆".repeat(5 - (product.popularity || 0));
  const mainImage = product.images && product.images.length > 0 ? 
    `http://localhost:5000/${product.images[0].replace(/\\/g, "/")}` : 
   //`https://saikrupapaithanisarees.onrender.com/${product.images[0].replace(/\\/g, "/")}` : 
    "https://via.placeholder.com/400x500?text=No+Image";
  
  const thumbnails = product.images ? product.images.map((img, i) => `
    <img src="http://localhost:5000/${img.replace(/\\/g, "/")}" class="thumbnail ${i === 0 ? "active" : ""}" width="70" height="70">
  `).join("") : "";
 
  
  // Determine stock status
  const isOutOfStock = product.stock === 0;
  const isLowStock = product.stock > 0 && product.stock <= 10;
  const stockStatusClass = isOutOfStock ? 'text-red-600 font-bold' : (isLowStock ? 'text-yellow-600 font-bold' : 'text-green-600 font-bold');
  const stockStatusText = isOutOfStock ? 'Out of Stock' : (isLowStock ? 'Low Stock' : 'In Stock');
  const buttonText = isOutOfStock ? 'Out of Stock' : 'Add to Cart';
  const buttonClass = isOutOfStock ? 'bg-gray-400 cursor-not-allowed' : 'bg-primary hover:bg-darkRed cursor-pointer';
  const stockBgClass = isOutOfStock ? 'stock-out' : (isLowStock ? 'stock-low' : 'stock-good');
  
  // Reset quantity to 1 when rendering
  quantity = 1;
  
  document.getElementById("productDetail").innerHTML = `
  <div class="md:flex bg-white rounded-lg shadow p-6">
    <div class="md:w-1/2 flex flex-col">
      <img src="${mainImage}" id="mainImage" class="saree-image rounded mb-4 w-full h-96 object-cover">
      ${thumbnails ? `<div class="flex space-x-2 mt-4 overflow-x-auto">${thumbnails}</div>` : ''}
    </div>
    <div class="md:w-1/2 md:pl-6 mt-4 md:mt-0 flex flex-col">
      <h1 class="text-3xl font-bold text-primary">${product.name}</h1>
      <div class="flex items-center text-gold mt-2 text-lg">${stars}</div>
      <div class="text-2xl font-bold text-primary mt-3">₹${product.price ? product.price.toLocaleString() : '0'}</div>
      
      <!-- Stock Quantity Display -->
      <div class="flex items-center mt-4 space-x-3 ${stockBgClass} p-4 rounded-lg border">
        <i class="fas ${isOutOfStock ? 'fa-times-circle text-red-500' : isLowStock ? 'fa-exclamation-triangle text-yellow-500' : 'fa-check-circle text-green-500'} text-xl"></i>
        <div>
          <span class="text-lg font-semibold ${stockStatusClass}">
            ${stockStatusText} - ${product.stock} units available
          </span>
          <p class="text-sm text-gray-600 mt-1">
            ${isOutOfStock ? 
              'This product is currently unavailable' : 
              isLowStock ? 
              'Only a few units left - Order soon!' : 
              'Available for immediate delivery'
            }
          </p>
        </div>
      </div>
      
      <div class="mb-4 mt-4">
        <h3 class="text-lg font-semibold text-black mb-2">Description:</h3>
        <p class="text-gray-700 leading-relaxed">${product.description || 'No description available.'}</p>
      </div>
     
      <div class="bg-lightGold p-4 rounded-lg mb-4">
        <h3 class="text-lg font-semibold text-black mb-2">Key Features:</h3>
        <ul class="text-gray-700 list-disc pl-5 space-y-1">
          <li>100% Authentic Handwoven Paithani</li>
          <li>Pure Silk with Golden Zari Work</li>
          <li>Traditional Peacock Motifs</li>
          <li>Comes with Authenticity Certificate</li>
          <li>Free Shipping & Easy Returns</li>
        </ul>
      </div>
      
      ${!isOutOfStock ? `
        <div class="flex items-center mt-4 space-x-4">
          <span class="text-lg font-semibold text-gray-700">Quantity:</span>
          <div class="flex items-center space-x-2 border border-gray-300 rounded-lg p-1">
            <button onclick="decreaseQuantity()" class="w-8 h-8 flex items-center justify-center bg-lightGold rounded hover:bg-gray-200 transition-colors">
              <i class="fas fa-minus text-sm"></i>
            </button>
            <span id="quantity" class="px-4 py-1 text-lg font-semibold min-w-12 text-center">${quantity}</span>
            <button onclick="increaseQuantity()" class="w-8 h-8 flex items-center justify-center bg-lightGold rounded hover:bg-gray-200 transition-colors">
              <i class="fas fa-plus text-sm"></i>
            </button>
          </div>
          <span class="text-sm text-gray-500">Max: ${product.stock} units</span>
        </div>
      ` : ''}
      
      <button id="addToCartBtn" class="mt-6 ${buttonClass} text-white px-6 py-3 rounded-lg text-lg font-semibold transition duration-300 flex items-center justify-center" 
        ${isOutOfStock ? 'disabled' : ''}>
        ${isOutOfStock ? 
          '<i class="fas fa-ban mr-2"></i> Out of Stock' : 
          '<i class="fas fa-shopping-cart mr-2"></i> Add to Cart'
        }
      </button>
      
      ${isOutOfStock ? `
        <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-red-700 text-center font-semibold">
            <i class="fas fa-exclamation-circle mr-2"></i>
            This product is currently out of stock. Please check back later.
          </p>
        </div>
      ` : ''}
    </div>
  </div>`;

  // Thumbnail click events
  document.querySelectorAll(".thumbnail").forEach(thumb => {
    thumb.addEventListener("click", () => {
      document.getElementById("mainImage").src = thumb.src;
      document.querySelectorAll(".thumbnail").forEach(t => t.classList.remove("active"));
      thumb.classList.add("active");
    });
  });

  // Add to cart event only if not out of stock
  if (!isOutOfStock) {
    document.getElementById("addToCartBtn").addEventListener("click", addToCartHandler);
  }
}

// UPDATED: Add to cart handler with logo loading animation
async function addToCartHandler() {
  try {
    const addToCartBtn = document.getElementById("addToCartBtn");
    const originalText = addToCartBtn.innerHTML;
    
    // Check if requested quantity is available
    if (quantity > currentProduct.stock) {
      showMessage(`Sorry, only ${currentProduct.stock} units available in stock.`, false);
      return;
    }

    // Show loading animation
    showLoading("Adding to Cart...");

    const authToken = getAuthToken();
    
    if (!authToken) {
      hideLoading();
      showMessage("Please login to add items to cart", false);
      setTimeout(() => {
        if (confirm("Redirect to login page?")) {
          window.location.href = "signup_login.html";
        }
      }, 1000);
      return;
    }

    // Calculate new stock
    const newStock = currentProduct.stock - quantity;
    
    // Update product in database using the main update endpoint
   const updateResponse = await fetch(`http://localhost:5000/api/products/${currentProduct._id}`, {
//  const updateResponse = await fetch(`https://saikrupapaithanisarees.onrender.com/api/products/${currentProduct._id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        "Authorization": `Bearer ${authToken}`
      },
      body: JSON.stringify({
        name: currentProduct.name,
        price: currentProduct.price,
        category: currentProduct.category,
        stock: newStock,
        description: currentProduct.description
      })
    });

    if (!updateResponse.ok) {
      const errorData = await updateResponse.json();
      throw new Error(errorData.error || 'Failed to update stock');
    }

    const updateResult = await updateResponse.json();
    console.log('Stock update result:', updateResult);

    // Then add to cart
    const requestBody = {
      productId: currentProduct._id,
      quantity: quantity
    };

   const res = await fetch("http://localhost:5000/api/cart/add", {
 // const res = await fetch("https://saikrupapaithanisarees.onrender.com/api/cart/add", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${authToken}`
      },
      body: JSON.stringify(requestBody)
    });

    const result = await res.json();

    if (!res.ok) {
      if (res.status === 401) {
        localStorage.removeItem('authToken');
        hideLoading();
        showMessage("Session expired. Please login again.", false);
        setTimeout(() => {
          window.location.href = "signup_login.html";
        }, 1500);
        return;
      }
      throw new Error(result.message || "Failed to add to cart");
    }

    if (result.success) {
      // Hide loading and show success message
      hideLoading();
      showMessage("Product added to cart successfully!");
      
      // Update product stock locally with the actual updated value
      currentProduct.stock = newStock;
      
      // Re-render product to show updated stock
      renderProduct(currentProduct);
      
      await updateCartCount();
    } else {
      throw new Error(result.message || "Failed to add to cart");
    }

  } catch (err) {
    console.error("Add to cart error:", err);
    // Hide loading and show error message
    hideLoading();
    showMessage("Failed to add to cart: " + err.message, false);
    
    // Reload product data to get correct stock
    await fetchProductData(currentProduct._id);
    
  } finally {
    const addToCartBtn = document.getElementById("addToCartBtn");
    if (addToCartBtn) {
      addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart mr-2"></i> Add to Cart';
      addToCartBtn.disabled = false;
    }
  }
}

// Related products
async function renderRelatedProducts(currentId){
  try{
    const res = await fetch("http://localhost:5000/api/products");
 // const res = await fetch("https://saikrupapaithanisarees.onrender.com/api/products");
    const products = await res.json();
    const related = products.filter(p => p._id !== currentId).slice(0, 7);
    
    // Initialize slider with related products
    initSlider(related);
  } catch(err){ 
    console.error(err); 
    document.getElementById('sliderTrack').innerHTML = '<p class="text-center py-4 text-gray-700 col-span-full">Failed to load related products.</p>';
  }
}

// Initialize everything with better error handling
document.addEventListener("DOMContentLoaded", async () => {
  console.log('DOM loaded, initializing...');
  
  const productId = getProductId();
  console.log('Product ID:', productId);
  
  if (productId) {
    try {
      await fetchProductData(productId);
      await renderRelatedProducts(productId);
      await renderReviewStats(productId);
      await renderReviews(productId);
    } catch (error) {
      console.error('Error loading product data:', error);
    }
  } else {
    console.error('No product ID found in URL');
  }
  
  // Initialize components
  initStarRating();
  initCharCounter();
  handleReviewForm();
  checkLoginStatus();
  updateCartCount();

  // Mobile menu
  const hamburger = document.querySelector(".hamburger");
  if (hamburger) {
    hamburger.addEventListener("click", () => {
      document.querySelector("nav ul").classList.toggle("hidden");
    });
  }
  
  // Slider event listeners
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  if (prevBtn) prevBtn.addEventListener('click', prevSlide);
  if (nextBtn) nextBtn.addEventListener('click', nextSlide);
  
  // Update slides per view on resize
  window.addEventListener('resize', updateSlidesPerView);
  updateSlidesPerView(); // Initial call
  
  console.log('Initialization complete');
});
</script>

</body>
</html>